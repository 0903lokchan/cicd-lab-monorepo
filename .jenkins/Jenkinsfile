pipeline {
    agent {
        label 'kaniko-agent'
    }

    stages {
        stage('Build & Push Changed Services') {
            steps {
                script {
                    // Get a list of changed directories
                    def changedFiles = sh(script: "git diff --name-only HEAD~1 HEAD", returnStdout: true).trim().split('\n')
                    def changedServices = [:]
                    for (def file : changedFiles) {
                        if (file.startsWith("services/")) {
                            def serviceName = file.split('/')[1]
                            changedServices[serviceName] = true
                        }
                    }

                    // If no services changed, skip this stage
                    if (changedServices.isEmpty()) {
                        echo "No services changed. Skipping build."
                        return
                    }

                    // Loop over each changed service and build it
                    for (def service : changedServices.keySet()) {
                        echo "Building service: ${service}"
                        
                        // Use the Docker Hub credentials we stored in Jenkins
                        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                            
                            // Execute the following steps inside the 'kaniko' container
                            container('kaniko') {
                                // 1. Create the Docker config file for Kaniko to authenticate with Docker Hub
                                sh """
                                echo "{\\"auths\\":{\\"https://index.docker.io/v1/\\":{\\"auth\\":\\"$(echo -n ${DOCKER_USER}:${DOCKER_PASS} | base64)\\"}}}" > /kaniko/.docker/config.json
                                """

                                // 2. Run the Kaniko build command
                                sh """
                                /kaniko/executor --context=/home/jenkins/agent/workspace/seed-job/services/${service} \\
                                                 --dockerfile=Dockerfile \\
                                                 --destination=0903lokchan/${service}:latest
                                """
                            }
                        }
                    }
                }
            }
        }
    }
}